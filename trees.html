<!DOCTYPE <!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Trees</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>  
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <script>
        let canvasWidth = .7;
    </script>
    <style>
        body { font-family: "Roboto"; font-size: 16pt; padding: 0; margin: 0; }
        .container { width: 100%; height: 100%; position: absolute; overflow: hidden;}
        .parameters { width: 30%; float: left; height: 100%; overflow-y: scroll; border-right: 2px #ddd solid; }
        .render { width: calc(70%-2px); float: left; height: 100%; overflow: hidden; }
        .parameters { font-size: 9pt; }
        canvas { position: absolute; }
        table { width: 100%; border-collapse: collapse; }
        
        td { padding: 8px;  font-size: 9pt; border: 1px #ddd solid; }
        tr { border-bottom: 1px #000 solid; }
        tr:hover { background-color: #eee; }
        input { width: 100%; font-size: 9pt; }
        hr { border-top: 0; border-bottom: 1px #ddd dashed;}

    </style>
</head>
<body>
    

    <div class="container">
        <div class="parameters">
            <div id="app">

                <table>
                    <tbody>
                        <tr>
                            <!-- DRAWING SETTINGS -->
                            <td colspan="2"><b>Drawing settings</b></td>
                        </tr>
                        <tr>
                            <td width="60%">Scale ({{ drawingSettings.scale }})<br/><small>Scaling of the canvas.</small></td>
                            <td><input type="range" min="1" max="25" step=".5" v-model.number="drawingSettings.scale"/></td>
                        </tr>
                        <tr>
                            <td width="60%">Position Y ({{ base.y }})<br/><small>Position of the object along the Y-axis.</small></td>
                            <td><input type="range" min="-250" max="250" step="1" v-model.number="base.y"/></td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <b>Recursion</b>
                            </td>
                        </tr>
                        <tr>
                            <td>Max depth ({{maxDepth}}) <br/><small>The amount of recursive steps.</small></td>
                            <td><input type="range" min="1" max="12" step="1" v-model.number="maxDepth"/></td>
                        </tr>
                        <tr>
                            <td colspan="2">
                                <b>Branching</b>
                            </td>
                        </tr>
                        <tr>
                            <td>Branch length ({{branchLength}}) <br/><small>Change the length of the branches.</small></td>
                            <td><input type="range" min="1" max="200" step="1" v-model.number="branchLength"/></td>
                        </tr>
                        <tr>
                            <td>Damping ({{branchDamping}}) <br/><small>Change how much the length is decreased over each recursive step.</small></td>
                            <td><input type="range" min="0.01" max="1" step="0.0025" v-model.number="branchDamping"/></td>
                        </tr>
                        <tr>
                            <td>Angle ({{branchAngle}}) <br/><small>Change the angle of the branches.</small></td>
                            <td><input type="range" min="-3.14159265" max="3.14159265" step="0.01" v-model.number="branchAngle"/></td>
                        </tr>
                        <tr>
                            <td>Branch length stdev ({{branchLengthStdev}}) <br/><small>Standard deviation of the branch length.</small></td>
                            <td><input type="range" min="0" max="100" step="1" v-model.number="branchLengthStdev"/></td>
                        </tr>
                        <tr>
                            <td>Probability distribution ({{branchLengthPDF}}) <br/><small>Probability distribution used for random branch length.</small></td>
                            <td style="text-align:center">
                                <select v-model="branchLengthPDF">
                                    <option value="uniform">Uniform</option>
                                    <option value="biased">Biased</option>
                                    <option value="normal">Normal</option>
                                </select>
                                <hr/>
                                <img style="width: 128px; height: 64px;"/>
                            </td>
                        </tr>
                        
                    </tbody>
                </table>

                <div style="text-align: center; padding: 16px;">
                    <small>Copyright 2018 - DarkEclipz</small>
                </div>
        
            </div>
        </div>
        <div class="render">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
    
        function map(x, a, b, c, d) {

            // let r1 = b-a;            // find the range of [a,b]
            // let xNorm = (x-b)/r1;    // normalize onto the range of [a,b]
            // let r2 = d-c;            // find the range of [c,d]
            // return xNorm * r2 + d;   // map x to the range of [c,d]

            /// ... is algebraically equivalent to:

            return ( (x-b) * (d-c) + d ) / (b - a);

        }

        function Vec2(x,y) {
            this.x=x;
            this.y=y;
            if(this.y == null) this.y=this.x;

            this.toString = function() {
                return this.x + ", " + this.y;
            }
          
            this.add = function(v) {
                return new Vec2(this.x+v.x, this.y+v.y);
            }
            this.subtract = function(v) {
                return new Vec2(this.x-v.x, this.y-v.y);
            }
            this.scale = function(scalar) {
                return new Vec2(scalar*this.x, scalar*this.y);
            }
            this.vmult = function(v) {
                return new Vec2(this.x*v.x, this.y*v.y);
            }
            this.dot = function(v) {
                return this.x*v.x + this.y*v.y;
            }
            this.length = function() {
                return Math.sqrt(this.x*this.x + this.y*this.y);
            }
            this.rotate = function(angle) {
                let c = Math.cos(angle);
                let s = Math.sin(angle);
                return new Vec2( c * this.x + -s * this.y, s * this.x + c * this.y );
            }
            this.distance = function(v) {
                x = this.x-v.x; y = this.y-v.y;
                return Math.sqrt(x*x + y*y);
            }
            this.apply = function(f) {
                return new Vec2(f(this.x), f(this.y));
            }
            this.floor = function() {
                return this.apply(Math.floor);
            }
            this.fract = function() {
                return this.subtract(this.apply(Math.floor));
            }
            this.normal = function() {
                return new Vec2(this.y, -this.x);
            }
            this.normalize = function() {
                var l = this.length();
                return new Vec2(this.x / l, this.y / l);
            }
            this.cross = function(v) {
                return this.length() * v.length () * this.angle(v);
            }
        }

        let canvas = document.getElementById('canvas');
        canvas.width = window.innerWidth * canvasWidth;
        canvas.height = window.innerHeight;
        let ctx = canvas.getContext('2d');

        let drawingSettings = {
            jointSize: 3,
            boneSize: 2,
            scale: 2
        }

        let vMoveTo = function(v) {
            ctx.moveTo(v.x, v.y);
        }

        let vLineTo = function(v) {
            ctx.lineTo(v.x, v.y);
        }

        let vJoint = function(v) {
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(v.x, v.y, drawingSettings.jointSize, 0, 2*Math.PI);
            ctx.fill();
            ctx.stroke();
        }

        let vBone = function(v, u) {
            ctx.lineWidth = drawingSettings.boneSize;
            ctx.beginPath();
            vMoveTo(v);
            vLineTo(u);
            ctx.stroke();
        }

        // Flip the canvas (origin in the lower left corner)
        ctx.translate(0, canvas.height);
        ctx.scale(1,-1);

        function Bone(jointA, jointB) { 
            this.jointStart = jointA,
            this.jointEnd = jointB
        }

        let base = new Vec2(0, -150);
        let up = new Vec2(0, 1);

        let branch = function(angle, depth, parent) {

            drawingSettings.jointSize = vue.maxDepth - depth;
            drawingSettings.boneSize = vue.maxDepth - depth;

            if(depth == vue.maxDepth) return;

            let alpha = depth / vue.maxDepth;

            let scale = new Vec2(1,1).scale(vue.branchLength*Math.pow((1-vue.branchDamping), depth));
            let L = up.rotate(angle + vue.branchAngle).vmult(scale).add(parent);
            let R = up.rotate(angle - vue.branchAngle).vmult(scale).add(parent);

            vBone(parent, L);
            vBone(parent, R);

            vJoint(L);
            vJoint(R);

            branch(angle + vue.branchAngle, depth+1, L);
            branch(angle - vue.branchAngle, depth+1, R);
            
        }

        let drawModel = function () {

            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(drawingSettings.scale, drawingSettings.scale);

            ctx.strokeStyle = "#000";
            ctx.fillStyle = "#ddd";

            vJoint(base);
            branch(0, 0, base);

            ctx.restore();
        }


        //drawModel();

        let vue = new Vue({
            el: "#app",
            data: {
                drawingSettings: drawingSettings,
                maxDepth: 8,
                branchAngle: 0.428,
                branchDamping: .21,
                branchLength: 68,
                base: base,
                branchLengthStdev: 8,
                branchLengthPDF: 'normal'
            }
        });

        let animate = function() {
            requestAnimationFrame(animate);
            ctx.fillStyle = "#fff";
            ctx.fillRect(-canvas.width, canvas.height, Math.max(drawingSettings.scale, 2) * canvas.width, -Math.max(drawingSettings.scale, 2) * canvas.height);
            drawModel();   
        }

        animate(); 

    </script>
</body>
</html>